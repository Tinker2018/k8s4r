# Mosquitto 混合安全配置
# 端口 1883: K8s4r Server（明文 + 用户名/密码）
# 端口 8883: K8s4r Agent（mTLS）

# 全局配置
persistence true
persistence_location /mosquitto/data/
log_dest stdout
log_type all

# ============================================
# Listener 1: 明文端口（给 K8s4r Server）
# ============================================
listener 1883
protocol mqtt

# 允许匿名访问（或者配置用户名/密码）
allow_anonymous true

# 如果需要用户名/密码认证，取消下面的注释
# allow_anonymous false
# password_file /mosquitto/config/passwd

# ACL 访问控制（可选）
# acl_file /mosquitto/config/acl.conf

# ============================================
# Listener 2: mTLS 端口（给 K8s4r Agent）
# ============================================
listener 8883
protocol mqtt

# SPIRE CA 证书（用于验证客户端证书）
cafile /mosquitto/certs/spire-ca.crt

# 要求客户端提供证书
require_certificate true

# 使用证书的 CN 或 SPIFFE ID 作为客户端标识
use_identity_as_username true

# 可选：如果需要服务器端证书（双向 TLS）
# certfile /mosquitto/certs/broker.crt
# keyfile /mosquitto/certs/broker.key
