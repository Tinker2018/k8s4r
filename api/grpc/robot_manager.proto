syntax = "proto3";

package grpc;

option go_package = "github.com/hxndg/k8s4r/api/grpc";

// RobotManager æœåŠ¡å®šä¹‰
// ========== åŒå‘é€šä¿¡æ¶æ„ ==========
// Server â†’ Manager: ä¸ŠæŠ¥æ³¨å†Œã€å¿ƒè·³ã€ä»»åŠ¡çŠ¶æ€
// Manager â†’ Server: æ¨é€ä»»åŠ¡åˆ›å»ºã€ä»»åŠ¡åˆ é™¤
service RobotManager {
  // å•å‘ RPCï¼šServer é€šçŸ¥ Manager æœ‰ Robot æ³¨å†Œ
  rpc ReportRobotRegistration(RegistrationRequest) returns (RegistrationResponse);
  
  // å•å‘ RPCï¼šServer é€šçŸ¥ Manager æ”¶åˆ°å¿ƒè·³
  rpc ReportRobotHeartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  
  // å•å‘ RPCï¼šServer é€šçŸ¥ Manager ä»»åŠ¡çŠ¶æ€å˜åŒ–
  rpc ReportTaskStatus(TaskStatusRequest) returns (TaskStatusResponse);
  
  // ========== ğŸ”¥ åŒå‘æµï¼šManager æ¨é€ä»»åŠ¡ç»™ Server ==========
  // Manager ç›‘å¬ K8s Task å˜åŒ–ï¼Œé€šè¿‡æ­¤æµæ¨é€ç»™ Server
  // Server å°†ä»»åŠ¡è½¬å‘åˆ° MQTT
  rpc StreamTasks(stream TaskEvent) returns (stream TaskCommand);
}

// ===== Robot æ³¨å†Œç›¸å…³ =====

message RegistrationRequest {
  string robot_id = 1;
  string token = 2;
  DeviceInfo device_info = 3;  // ç®€åŒ–çš„è®¾å¤‡ä¿¡æ¯
  string device_info_json = 4; // å®Œæ•´çš„è®¾å¤‡ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰
}

message RegistrationResponse {
  bool success = 1;
  string message = 2;
}

// ===== Robot å¿ƒè·³ç›¸å…³ =====

message HeartbeatRequest {
  string robot_id = 1;
  string token = 2;
  DeviceInfo device_info = 3;  // ç®€åŒ–çš„è®¾å¤‡ä¿¡æ¯
  string device_info_json = 4; // å®Œæ•´çš„è®¾å¤‡ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰
}

message HeartbeatResponse {
  bool success = 1;
  string message = 2;
}

// ===== ä»»åŠ¡çŠ¶æ€ä¸ŠæŠ¥ç›¸å…³ =====

message TaskStatusRequest {
  string task_uid = 1;
  string robot_name = 2;
  string state = 3;        // pending, running, completed, failed, dead
  int32 exit_code = 4;
  string message = 5;
  string event = 6;        // Assigned, Downloading, Starting, Started, Completed, Failed
  int64 updated_at = 7;    // Unix timestamp
}

message TaskStatusResponse {
  bool success = 1;
  string message = 2;
}

// ===== ğŸ”¥ åŒå‘æµï¼šä»»åŠ¡æ¨é€ =====

// TaskCommand Manager â†’ Server çš„æŒ‡ä»¤
message TaskCommand {
  enum CommandType {
    CREATE_TASK = 0;   // åˆ›å»ºä»»åŠ¡
    DELETE_TASK = 1;   // åˆ é™¤ä»»åŠ¡
    KEEPALIVE = 2;     // ä¿æŒè¿æ¥
  }
  
  CommandType type = 1;
  Task task = 2;       // type=CREATE_TASK æ—¶æœ‰æ•ˆ
  string task_uid = 3; // type=DELETE_TASK æ—¶æœ‰æ•ˆ
}

// TaskEvent Server â†’ Manager çš„äº‹ä»¶ï¼ˆç¡®è®¤æ”¶åˆ°ï¼‰
message TaskEvent {
  enum EventType {
    ACK = 0;           // ç¡®è®¤æ”¶åˆ°æŒ‡ä»¤
    PUBLISHED = 1;     // å·²å‘å¸ƒåˆ° MQTT
    ERROR = 2;         // å¤„ç†å¤±è´¥
    KEEPALIVE = 3;     // ä¿æŒè¿æ¥
  }
  
  EventType type = 1;
  string task_uid = 2;
  string message = 3;
}

// Task å®Œæ•´çš„ä»»åŠ¡ä¿¡æ¯
message Task {
  // Metadata
  string uid = 1;
  string name = 2;
  string namespace = 3;
  
  // Spec
  string job_name = 4;
  string target_robot = 5;
  string driver = 6;
  string config = 7;        // JSON å­—ç¬¦ä¸²
  int64 timeout = 8;        // ç§’
  int64 kill_timeout = 9;   // ç§’
  map<string, string> env = 10;
  
  // Status
  string state = 11;        // pending, dispatching, running, completed, failed
  string message = 12;
}

// ===== è®¾å¤‡ä¿¡æ¯ =====

message DeviceInfo {
  string hostname = 1;
  string os = 2;
  string arch = 3;
  int32 num_cpus = 4;
  int64 total_memory = 5;
  string kernel_version = 6;
  map<string, string> labels = 7;
}
