syntax = "proto3";

package grpc;

option go_package = "github.com/hxndghxndg/k8s4r/api/grpc";

// RobotManager 服务定义
// ========== 双向通信架构 ==========
// Server → Manager: 上报注册、心跳、任务状态
// Manager → Server: 推送任务创建、任务删除
service RobotManager {
  // 单向 RPC：Server 通知 Manager 有 Robot 注册
  rpc ReportRobotRegistration(RegistrationRequest) returns (RegistrationResponse);
  
  // 单向 RPC：Server 通知 Manager 收到心跳
  rpc ReportRobotHeartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  
  // 单向 RPC：Server 通知 Manager 任务状态变化
  rpc ReportTaskStatus(TaskStatusRequest) returns (TaskStatusResponse);
  
  // ==========  双向流：Manager 推送任务给 Server ==========
  // Manager 监听 K8s Task 变化，通过此流推送给 Server
  // Server 将任务转发到 MQTT
  rpc StreamTasks(stream TaskEvent) returns (stream TaskCommand);
}

// ===== Robot 注册相关 =====

message RegistrationRequest {
  string robot_id = 1;
  string token = 2;
  DeviceInfo device_info = 3;  // 简化的设备信息
  string device_info_json = 4; // 完整的设备信息（JSON格式）
}

message RegistrationResponse {
  bool success = 1;
  string message = 2;
}

// ===== Robot 心跳相关 =====

message HeartbeatRequest {
  string robot_id = 1;
  string token = 2;
  DeviceInfo device_info = 3;  // 简化的设备信息
  string device_info_json = 4; // 完整的设备信息（JSON格式）
}

message HeartbeatResponse {
  bool success = 1;
  string message = 2;
}

// ===== 任务状态上报相关 =====

message TaskStatusRequest {
  string task_uid = 1;
  string robot_name = 2;
  string state = 3;        // pending, running, completed, failed, dead
  int32 exit_code = 4;
  string message = 5;
  string event = 6;        // Assigned, Downloading, Starting, Started, Completed, Failed
  int64 updated_at = 7;    // Unix timestamp
}

message TaskStatusResponse {
  bool success = 1;
  string message = 2;
}

// =====  双向流：任务推送 =====

// TaskCommand Manager → Server 的指令
message TaskCommand {
  enum CommandType {
    CREATE_TASK = 0;   // 创建任务
    DELETE_TASK = 1;   // 删除任务
    KEEPALIVE = 2;     // 保持连接
  }
  
  CommandType type = 1;
  Task task = 2;       // type=CREATE_TASK 时有效
  string task_uid = 3; // type=DELETE_TASK 时有效
}

// TaskEvent Server → Manager 的事件（确认收到）
message TaskEvent {
  enum EventType {
    ACK = 0;           // 确认收到指令
    PUBLISHED = 1;     // 已发布到 MQTT
    ERROR = 2;         // 处理失败
    KEEPALIVE = 3;     // 保持连接
  }
  
  EventType type = 1;
  string task_uid = 2;
  string message = 3;
}

// Task 完整的任务信息
message Task {
  // Metadata
  string uid = 1;
  string name = 2;
  string namespace = 3;
  
  // Spec
  string job_name = 4;
  string target_robot = 5;
  string driver = 6;
  string config = 7;        // JSON 字符串
  int64 timeout = 8;        // 秒
  int64 kill_timeout = 9;   // 秒
  map<string, string> env = 10;
  
  // Status
  string state = 11;        // pending, dispatching, running, completed, failed
  string message = 12;
}

// ===== 设备信息 =====

message DeviceInfo {
  string hostname = 1;
  string os = 2;
  string arch = 3;
  int32 num_cpus = 4;
  int64 total_memory = 5;
  string kernel_version = 6;
  map<string, string> labels = 7;
}
