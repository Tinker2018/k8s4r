syntax = "proto3";

package grpc;

option go_package = "github.com/hxndghxndg/k8s4r/api/grpc";

// RobotManager 服务定义
// ========== 双向通信架构 ==========
// Server → Manager: 上报注册、心跳、任务状态
// Manager → Server: 推送任务创建、任务删除
service RobotManager {
  // 单向 RPC：Server 通知 Manager 有 Robot 注册
  rpc ReportRobotRegistration(RegistrationRequest) returns (RegistrationResponse);
  
  // 单向 RPC：Server 通知 Manager 收到心跳
  rpc ReportRobotHeartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  
  // 单向 RPC：Server 通知 Manager 任务状态变化
  rpc ReportTaskStatus(TaskStatusRequest) returns (TaskStatusResponse);
  
  // ==========  双向流：Manager 推送 TaskGroup 给 Server ==========
  // Manager 监听 K8s TaskGroup 变化，通过此流推送给 Server
  // Server 将 TaskGroup 转发到 MQTT
  rpc StreamTaskGroups(stream TaskGroupEvent) returns (stream TaskGroupCommand);
}

// ===== Robot 注册相关 =====

message RegistrationRequest {
  string robot_id = 1;
  string token = 2;
  DeviceInfo device_info = 3;  // 简化的设备信息
  string device_info_json = 4; // 完整的设备信息（JSON格式）
}

message RegistrationResponse {
  bool success = 1;
  string message = 2;
}

// ===== Robot 心跳相关 =====

message HeartbeatRequest {
  string robot_id = 1;
  string token = 2;
  DeviceInfo device_info = 3;  // 简化的设备信息
  string device_info_json = 4; // 完整的设备信息（JSON格式）
}

message HeartbeatResponse {
  bool success = 1;
  string message = 2;
}

// ===== 任务状态上报相关 =====

message TaskStatusRequest {
  string task_uid = 1;
  string robot_name = 2;
  string state = 3;        // pending, running, completed, failed, dead
  int32 exit_code = 4;
  string message = 5;
  string event = 6;        // Assigned, Downloading, Starting, Started, Completed, Failed
  int64 updated_at = 7;    // Unix timestamp
}

message TaskStatusResponse {
  bool success = 1;
  string message = 2;
}

// =====  双向流：TaskGroup 推送 =====

// TaskGroupCommand Manager → Server 的指令
message TaskGroupCommand {
  enum CommandType {
    CREATE_TASKGROUP = 0;   // 创建任务组
    DELETE_TASKGROUP = 1;   // 删除任务组
    KEEPALIVE = 2;          // 保持连接
  }
  
  CommandType type = 1;
  string taskgroup_json = 2;  // 完整的 TaskGroup JSON（包含所有字段）
  string taskgroup_uid = 3;   // TaskGroup UID
  string robot_name = 4;      // 目标机器人名称
}

// TaskGroupEvent Server → Manager 的事件（确认收到）
message TaskGroupEvent {
  enum EventType {
    ACK = 0;           // 确认收到指令
    PUBLISHED = 1;     // 已发布到 MQTT
    ERROR = 2;         // 处理失败
    KEEPALIVE = 3;     // 保持连接
  }
  
  EventType type = 1;
  string taskgroup_uid = 2;   // 任务组 UID
  string robot_name = 3;      // 机器人名称
  string message = 4;
}

// ===== 设备信息 =====

message DeviceInfo {
  string hostname = 1;
  string os = 2;
  string arch = 3;
  int32 num_cpus = 4;
  int64 total_memory = 5;
  string kernel_version = 6;
  map<string, string> labels = 7;
}
